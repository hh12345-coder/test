# 功能实现说明

## 已实现的功能

### 1. 多课表截图上传 ✅
- **接口**: `POST /api/schedule/upload/screenshots`
- **功能**: 支持同时上传多个课表截图文件
- **返回**: 每个文件的解析结果，包括成功/失败状态和解析后的课表数据
- **使用**: 前端可以调用此接口批量上传多个课表

### 2. 手动排除时间段 ✅
- **接口**: `POST /api/schedule/free_times`
- **功能**: 在计算空闲时间时，可以手动指定需要排除的时间段
- **参数**: `excluded_times` - 排除时间段列表，格式：`[{"day": "周一", "start": "12:00", "end": "13:00"}, ...]`
- **使用**: 用户可以在计算空闲时间时，排除自己不方便的时间段

### 3. 团队管理功能集成 ✅
- **接口**: `POST /api/schedule/team/{team_id}/free_times`
- **功能**: 
  - 团队成员可以一起上传课表
  - 自动获取所有团队成员的课表
  - 计算所有成员的共同空闲时间
- **权限**: 只有团队成员才能访问
- **使用流程**:
  1. 创建团队（已有接口）
  2. 邀请成员加入团队（已有接口）
  3. 每个成员上传自己的课表（使用 `/api/schedule/save`）
  4. 调用团队空闲时间计算接口获取共同空闲时间

### 4. 学校选择功能 ✅
- **接口**: 
  - `GET /api/schools` - 获取所有学校列表
  - `GET /api/schools/{school_id}` - 获取学校详情
- **数据模型**: `School` 表，包含学校名称、经纬度、城市、省份
- **预置数据**: 已预置上海地区主要高校（上海财经大学、复旦大学、同济大学等）
- **使用**: 前端可以显示学校列表供用户选择，而不是手动输入经纬度

### 5. 地点推荐支持学校选择 ✅
- **接口**: `POST /api/places/recommend`
- **新参数**: 
  - `school_ids`: 学校ID列表（优先使用）
  - `coords`: 经纬度列表（向后兼容，已废弃）
  - `travel_mode`: 出行方式，可选值：`walking`（步行，默认）、`transit`（公共交通）、`driving`（驾车）
- **功能**: 
  - 根据选择的学校自动获取坐标
  - 支持步行、公共交通、驾车三种出行方式的时间计算
  - 默认使用步行时间计算

### 6. 出行时间计算优化 ✅
- **功能**: 地点推荐接口现在默认使用步行时间，而不是驾车时间
- **API**: 使用百度地图的 `routematrix/v2/walking` 和 `routematrix/v2/transit` API
- **回退机制**: 如果API调用失败，使用直线距离估算（步行速度5km/h，公共交通20km/h）

### 7. 课表保存功能 ✅
- **接口**: 
  - `POST /api/schedule/save` - 保存用户课表到数据库
  - `GET /api/schedule/my` - 获取当前用户的课表
- **功能**: 用户可以保存课表到数据库，方便团队功能使用

## API 使用示例

### 1. 批量上传课表截图
```python
POST /api/schedule/upload/screenshots
Content-Type: multipart/form-data

files: [file1.jpg, file2.jpg, ...]
```

### 2. 计算空闲时间（带排除时间段）
```python
POST /api/schedule/free_times
{
    "schedules": [
        [{"day": "周一", "start": "08:00", "end": "10:00"}],
        [{"day": "周二", "start": "14:00", "end": "16:00"}]
    ],
    "week": 1,
    "excluded_times": [
        {"day": "周一", "start": "12:00", "end": "13:00"}
    ]
}
```

### 3. 计算团队空闲时间
```python
POST /api/schedule/team/1/free_times
{
    "week": 1,
    "excluded_times": []
}
```

### 4. 地点推荐（使用学校）
```python
POST /api/places/recommend
{
    "school_ids": [1, 2, 3],
    "cuisine": "餐厅",
    "radius": 3000,
    "travel_mode": "walking"
}
```

### 5. 保存课表
```python
POST /api/schedule/save
{
    "schedule_data": [
        {"day": "周一", "start": "08:00", "end": "10:00"},
        {"day": "周二", "start": "14:00", "end": "16:00"}
    ]
}
```

## 数据库模型

### School 表
- `id`: 主键
- `name`: 学校名称（唯一）
- `lat`: 纬度
- `lon`: 经度
- `city`: 城市
- `province`: 省份

### Schedule 表（已有）
- `id`: 主键
- `user_id`: 用户ID
- `day`: 星期几
- `start`: 开始时间
- `end`: 结束时间

## 注意事项

1. **学校数据初始化**: 首次调用 `/api/schools` 时会自动初始化默认学校数据
2. **团队权限**: 只有团队成员才能访问团队的课表和空闲时间
3. **出行方式**: 默认使用步行时间，如需驾车时间，设置 `travel_mode: "driving"`
4. **向后兼容**: 地点推荐接口仍然支持 `coords` 参数，但建议使用 `school_ids`

## 待完善功能

1. 前端界面需要更新以支持新功能
2. 可以考虑添加更多学校数据
3. 可以优化空闲时间计算的算法，支持更灵活的时间段匹配

